<!DOCTYPE html>
<html>

<head>
    <title>Sugestões de Normativos</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="[https://fonts.googleapis.com](https://fonts.googleapis.com)">
    <link rel="preconnect" href="[https://fonts.gstatic.com](https://fonts.gstatic.com)" crossorigin>
    <link href="[https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap)" rel="stylesheet">
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>

    <!-- Script do Tailwind CSS para um design moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Script da API do Office.js - Essencial para a comunicação com o Word -->
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js" type="text/javascript"></script>

    <style>
        /* Estilos adicionais para garantir uma boa experiência */
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Evita scrollbars desnecessárias no corpo */
        }
        main {
            scrollbar-width: thin; /* Para Firefox */
            scrollbar-color: #a0aec0 #edf2f7; /* Para Firefox */
        }
        main::-webkit-scrollbar {
            width: 8px;
        }
        main::-webkit-scrollbar-track {
            background: #edf2f7;
        }
        main::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 10px;
            border: 3px solid #edf2f7;
        }
    </style>
</head>

<body class="bg-gray-50 p-4">
    <div id="app" class="flex flex-col h-screen">
        <!-- Cabeçalho do Painel -->
        <header>
            <h1 class="text-xl font-bold text-gray-800">Sugestões de Normativos</h1>
            <p id="subtitle" class="text-sm text-gray-500 mt-1">Digite no documento para ver sugestões.</p>
        </header>

        <!-- Caixa de texto para simulação no navegador -->
        <div id="browser-simulation-area" class="hidden my-4">
            <label for="text-simulator" class="block text-sm font-medium text-gray-700">Simulador (apenas na pré-visualização):</label>
            <textarea id="text-simulator" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Digite 'política de segurança' ou 'lgpd'..."></textarea>
        </div>

        <hr class="my-4">

        <!-- Área onde as sugestões aparecerão -->
        <main class="flex-grow overflow-y-auto pb-4">
            <div id="loading-message" class="text-center text-gray-600">
                <p>Aguardando sua digitação...</p>
            </div>
            <div id="suggestions-container" class="space-y-2">
                <!-- As sugestões serão injetadas aqui -->
            </div>
        </main>

        <!-- Rodapé -->
        <footer class="mt-4 text-center text-xs text-gray-400 shrink-0">
            <p>&copy; 2024 Assistente de Auditoria</p>
        </footer>
    </div>

    <script type="text/javascript">
        // --- 1. BASE DE CONHECIMENTO (NORMATIVOS) ---
        // Seus dados JSON ficam aqui. Em um projeto real, você poderia carregar de um arquivo externo.
        const baseDeNormativos = [
          {
            "id": "iso_27001_a5_1",
            "titulo": "ISO 27001 - A.5.1",
            "descricao": "Políticas para segurança da informação",
            "texto": "Uma política de segurança da informação deve ser definida, aprovada pela direção, publicada e comunicada aos funcionários e partes externas relevantes.",
            "palavrasChave": ["política de segurança", "psi", "documentação de segurança", "sgsi"]
          },
          {
            "id": "lgpd_art_7",
            "titulo": "LGPD - Art. 7º",
            "descricao": "Tratamento de Dados Pessoais",
            "texto": "O tratamento de dados pessoais somente poderá ser realizado nas seguintes hipóteses: I - mediante o fornecimento de consentimento pelo titular; II - para o cumprimento de obrigação legal ou regulatória pelo controlador...",
            "palavrasChave": ["lgpd", "tratamento de dados", "consentimento", "obrigação legal"]
          },
          {
            "id": "bacen_4658",
            "titulo": "Bacen Res. 4.658/18",
            "descricao": "Política de segurança cibernética",
            "texto": "As instituições financeiras devem implementar e manter uma política de segurança cibernética formulada com base em princípios e diretrizes que busquem assegurar a confidencialidade, a integridade e a disponibilidade dos dados e dos sistemas de informação utilizados.",
            "palavrasChave": ["bacen", "segurança cibernética", "instituição financeira", "resolução 4658"]
          }
        ];

        // --- INICIALIZAÇÃO DO SUPLEMENTO ---
        Office.onReady(info => {
            if (info.host === Office.HostType.Word) {
                console.log("Modo Word: Suplemento carregado!");
                setupWordListeners();
            } else {
                console.log("Modo Navegador (Simulação): Carregado!");
                setupBrowserSimulation();
            }
        });

        // --- LÓGICA PARA O MODO WORD ---
        function setupWordListeners() {
            const loadingMessage = document.getElementById('loading-message');
            const suggestionsContainer = document.getElementById('suggestions-container');
            Office.context.document.addHandlerAsync(Office.EventType.SelectionChanged, () => getWordContextAndCheck(loadingMessage, suggestionsContainer));
            getWordContextAndCheck(loadingMessage, suggestionsContainer);
        }

        async function getWordContextAndCheck(loadingEl, containerEl) {
            try {
                await Word.run(async (context) => {
                    const paragraph = context.document.getSelection().paragraphs.getFirst();
                    paragraph.load("text");
                    await context.sync();
                    const suggestions = encontrarSugestoes(paragraph.text, baseDeNormativos);
                    updateSuggestionsUI(suggestions, loadingEl, containerEl, true);
                });
            } catch (error) {
                console.error("Erro ao interagir com o documento do Word:", error);
            }
        }
        
        // --- LÓGICA PARA O MODO DE SIMULAÇÃO (NAVEGADOR) ---
        function setupBrowserSimulation() {
            document.getElementById('browser-simulation-area').classList.remove('hidden');
            document.getElementById('subtitle').textContent = "Use a caixa abaixo para testar as sugestões.";
            
            const simulator = document.getElementById('text-simulator');
            const loadingMessage = document.getElementById('loading-message');
            const suggestionsContainer = document.getElementById('suggestions-container');

            simulator.addEventListener('input', () => {
                const suggestions = encontrarSugestoes(simulator.value, baseDeNormativos);
                updateSuggestionsUI(suggestions, loadingMessage, suggestionsContainer, false);
            });
             // Força uma verificação inicial para mostrar a UI corretamente
            updateSuggestionsUI([], loadingMessage, suggestionsContainer, false);
        }

        // --- MOTOR DE SUGESTÃO (NÍVEL 1) ---
        function encontrarSugestoes(textoDoParagrafo, baseDeNormativos) {
          const sugestoesEncontradas = [];
          const textoMinusculo = textoDoParagrafo.toLowerCase();
          if (textoMinusculo.trim().length < 3) return [];

          for (const normativo of baseDeNormativos) {
            for (const palavraChave of normativo.palavrasChave) {
              if (textoMinusculo.includes(palavraChave.toLowerCase())) {
                if (!sugestoesEncontradas.some(s => s.id === normativo.id)) {
                  sugestoesEncontradas.push(normativo);
                }
                break; 
              }
            }
          }
          return sugestoesEncontradas;
        }

        // --- ATUALIZAÇÃO DA INTERFACE ---
        function updateSuggestionsUI(suggestions, loadingEl, containerEl, isWordMode) {
            containerEl.innerHTML = ''; 
            if (suggestions.length > 0) {
                loadingEl.style.display = 'none';
                suggestions.forEach(normativo => {
                    const card = document.createElement('div');
                    card.className = "bg-white p-3 rounded-lg shadow-sm border border-gray-200 hover:border-blue-500 hover:shadow-md cursor-pointer transition-all";
                    card.innerHTML = `
                        <p class="font-bold text-blue-700">${normativo.titulo}</p>
                        <p class="text-sm text-gray-600 mt-1">${normativo.descricao}</p>
                    `;
                    card.onclick = () => {
                        if (isWordMode) {
                            insertNormativoTextIntoWord(normativo.texto);
                        } else {
                            alert(`Simulação: O texto abaixo seria inserido no Word:\n\n"${normativo.texto}"`);
                        }
                    };
                    containerEl.appendChild(card);
                });
            } else {
                loadingEl.style.display = 'block';
                loadingEl.textContent = "Nenhuma sugestão para o contexto atual.";
            }
        }

        // --- AÇÃO DE INSERIR TEXTO (APENAS PARA O WORD) ---
        async function insertNormativoTextIntoWord(textToInsert) {
            try {
                await Word.run(async (context) => {
                    const selection = context.document.getSelection();
                    selection.insertText(textToInsert + ' ', Word.InsertLocation.replace);
                    await context.sync();
                });
            } catch (error) {
                console.error("Erro ao inserir texto no Word:", error);
            }
        }
    </script>
</body>
</html>
